name: Update Index

on:
  # Push åˆ° main åˆ†æ”¯æ—¶è§¦å‘
  push:
    branches: [ main, master ]
  # æ¯å°æ—¶è¿è¡Œä¸€æ¬¡
  schedule:
    - cron: '0 * * * *'
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-index:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´ git å†å²ä»¥ä¾¿è·å–æäº¤ä¿¡æ¯
    
    - name: Generate files.json
      run: |
        #!/bin/bash
        
        # åˆ›å»º files.json
        echo '[' > files.json
        
        first=true
        # æŸ¥æ‰¾æ‰€æœ‰ .html æ–‡ä»¶ï¼Œæ’é™¤ index.html
        for file in $(find . -maxdepth 1 -name "*.html" -type f | grep -v "index.html" | sort); do
          # ç§»é™¤ ./ å‰ç¼€
          filename=$(basename "$file")
          
          # è·å–æ–‡ä»¶å¤§å°
          size=$(stat -c%s "$file")
          
          # ä» git log è·å–æœ€åä¿®æ”¹æ—¶é—´å’Œæäº¤ä¿¡æ¯
          last_commit=$(git log -1 --format="%H|%ci|%s" -- "$file" 2>/dev/null || echo "||")
          
          if [ -z "$last_commit" ] || [ "$last_commit" = "||" ]; then
            # æ–‡ä»¶æœªæäº¤åˆ° gitï¼Œä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿæ—¶é—´ï¼ˆISO 8601 æ ¼å¼ï¼‰
            modified=$(date -r "$file" +"%Y-%m-%dT%H:%M:%S%:z")
            commit_message=""
          else
            # è§£æ git log è¾“å‡º
            commit_hash=$(echo "$last_commit" | cut -d'|' -f1)
            # å°† Git æ—¥æœŸæ ¼å¼è½¬æ¢ä¸º ISO 8601 æ ¼å¼
            # Git: 2026-02-11 01:38:45 +0800 -> ISO: 2026-02-11T01:38:45+08:00
            git_date=$(echo "$last_commit" | cut -d'|' -f2)
            modified=$(echo "$git_date" | sed 's/ /T/' | sed 's/\([+-]\)\([0-9]\{2\}\)\([0-9]\{2\}\)$/\1\2:\3/')
            commit_message=$(echo "$last_commit" | cut -d'|' -f3-)
          fi
          
          # æå–æ–‡ä»¶æ ‡é¢˜ï¼ˆä» <title> æ ‡ç­¾ï¼‰
          title=$(grep -oP '(?<=<title>)[^<]+' "$file" 2>/dev/null || echo "")
          if [ -z "$title" ]; then
            title="${filename%.html}"
          fi
          
          # æ·»åŠ é€—å·åˆ†éš”ç¬¦ï¼ˆé™¤äº†ç¬¬ä¸€ä¸ªå…ƒç´ ï¼‰
          if [ "$first" = true ]; then
            first=false
          else
            echo ',' >> files.json
          fi
          
          # å†™å…¥ JSON å¯¹è±¡
          cat >> files.json << EOF
        {
          "filename": $(echo "$filename" | jq -R .),
          "title": $(echo "$title" | jq -R .),
          "size": $size,
          "modified": $(echo "$modified" | jq -R .),
          "commitMessage": $(echo "$commit_message" | jq -R .)
        }
        EOF
        done
        
        echo '' >> files.json
        echo ']' >> files.json
        
        # éªŒè¯ç”Ÿæˆçš„ JSON
        if jq empty files.json 2>/dev/null; then
          echo "âœ… files.json ç”ŸæˆæˆåŠŸ"
          cat files.json
        else
          echo "âŒ files.json æ ¼å¼é”™è¯¯"
          cat files.json
          exit 1
        fi
    
    - name: Commit and push if changed
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
        if git diff --quiet files.json 2>/dev/null && [ -f files.json ]; then
          echo "ğŸ“‹ files.json æ²¡æœ‰å˜æ›´ï¼Œè·³è¿‡æäº¤"
        else
          git add files.json
          git commit -m "ğŸ¤– Auto-update files.json [$(date '+%Y-%m-%d %H:%M:%S')]" || exit 0
          git push
          echo "âœ… files.json å·²æäº¤åˆ°ä»“åº“"
        fi
